# GitLab CI/CD Pipeline pour SpotNow
# Stages: type-check ‚Üí lint ‚Üí build ‚Üí deploy
#
# Ce pipeline v√©rifie le code avant chaque d√©ploiement :
# 1. Type checking TypeScript
# 2. Linting ESLint
# 3. Build Next.js (v√©rifie que tout compile)
# 4. Deploy (optionnel si vous utilisez Vercel)

stages:
  - type-check
  - lint
  - build
  - deploy

# Variables globales
variables:
  NODE_VERSION: "20"
  CACHE_KEY: ${CI_COMMIT_REF_SLUG}

# Cache pour acc√©l√©rer les builds
cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - node_modules/
    - .next/cache/

# Image Node.js
image: node:${NODE_VERSION}-alpine

# Installation des d√©pendances (job r√©utilisable)
.before_script: &before_script
  - echo "üì¶ Installing dependencies..."
  - npm ci --prefer-offline --no-audit
  - echo "‚úÖ Dependencies installed"

# Stage 1: Type Checking
type-check:
  stage: type-check
  <<: *before_script
  script:
    - echo "üîç Running TypeScript type checking..."
    - npm run type-check
    - echo "‚úÖ Type checking passed!"
  artifacts:
    when: on_failure
    paths:
      - "**/*.tsbuildinfo"
    expire_in: 1 week
  allow_failure: false
  only:
    - merge_requests
    - main
    - develop
    - branches

# Stage 2: Linting
lint:
  stage: lint
  <<: *before_script
  script:
    - echo "üîç Running ESLint..."
    - npm run lint
    - echo "‚úÖ Linting passed!"
  artifacts:
    when: on_failure
    reports:
      junit: eslint-report.xml
    expire_in: 1 week
  allow_failure: false
  only:
    - merge_requests
    - main
    - develop
    - branches

# Stage 3: Build
build:
  stage: build
  <<: *before_script
  script:
    - echo "üèóÔ∏è Building Next.js application..."
    - npm run build
    - echo "‚úÖ Build successful!"
  artifacts:
    paths:
      - .next/
    expire_in: 1 hour
  allow_failure: false
  only:
    - merge_requests
    - main
    - develop
    - branches
  # Ne build que si type-check et lint passent
  needs:
    - type-check
    - lint

# Stage 4: Deploy (optionnel)
# Note: Si vous utilisez Vercel, ce stage n'est pas n√©cessaire
# car Vercel se connecte directement √† votre repo GitLab
# et d√©ploie automatiquement sur push vers main
deploy:
  stage: deploy
  image: alpine:latest
  script:
    - echo "üöÄ Deployment stage"
    - echo "‚ÑπÔ∏è  If using Vercel, deployments happen automatically"
    - echo "‚ÑπÔ∏è  Vercel connects to GitLab and deploys on push to main"
    - echo "‚úÖ Deployment configuration complete"
  environment:
    name: production
    url: https://your-domain.vercel.app
  only:
    - main
  when: manual # D√©ploiement manuel pour s√©curit√©
  needs:
    - build

